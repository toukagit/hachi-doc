"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[5183],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),p=c(n),m=r,h=p["".concat(s,".").concat(m)]||p[m]||u[m]||i;return n?a.createElement(h,o(o({ref:t},d),{},{components:n})):a.createElement(h,o({ref:t},d))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},523:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return u}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),o=["components"],l={title:"In-app purchase",sidebar_label:"In-app purchase",description:"",sidebar_position:3},s="In-app purchase",c={unversionedId:"IAP",id:"version-4.0.0/IAP",title:"In-app purchase",description:"",source:"@site/i18n/en/docusaurus-plugin-content-docs/version-4.0.0/IAP.md",sourceDirName:".",slug:"/IAP",permalink:"/hachi-doc/IAP",tags:[],version:"4.0.0",sidebarPosition:3,frontMatter:{title:"In-app purchase",sidebar_label:"In-app purchase",description:"",sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Remote Config",permalink:"/hachi-doc/remoteConfig"},next:{title:"Account system",permalink:"/hachi-doc/login"}},d={},u=[{value:"In-app purchase access method",id:"in-app-purchase-access-method",level:2},{value:"1\u3001Import IAP plug-in",id:"1import-iap-plug-in",level:3},{value:"2\u3001Add macro definition",id:"2add-macro-definition",level:3},{value:"3\u3001Add in-store items",id:"3add-in-store-items",level:3},{value:"4\u3001Initialize iap callback",id:"4initialize-iap-callback",level:3},{value:"5\u3001Buy listening callback",id:"5buy-listening-callback",level:3},{value:"6\u3001Purchase interface",id:"6purchase-interface",level:3},{value:"7\u3001Restore purchase (iOS Only)",id:"7restore-purchase-ios-only",level:3},{value:"8\u3001Reward issuance report(Must join)",id:"8reward-issuance-reportmust-join",level:3},{value:"9\u3001replenishment",id:"9replenishment",level:3},{value:"10\u3001Gets the localized price string interface",id:"10gets-the-localized-price-string-interface",level:3},{value:"11\u3001Query Continuous Subscription product information (v3.1.4 new)",id:"11query-continuous-subscription-product-information-v314-new",level:3},{value:"11.1 Registration callback",id:"111-registration-callback",level:4},{value:"11.2 Active query",id:"112-active-query",level:4},{value:"12\u3001Get all product information\uff08optional\uff09",id:"12get-all-product-informationoptional",level:3},{value:"13\u3001Get product information based on product ID\uff08optional\uff09",id:"13get-product-information-based-on-product-idoptional",level:3},{value:"14\u3001The in-app purchase is abnormal",id:"14the-in-app-purchase-is-abnormal",level:3},{value:"15\u3001Products with ads removed must be accepted",id:"15products-with-ads-removed-must-be-accepted",level:3},{value:"Server Integration (Optional)",id:"server-integration-optional",level:2},{value:"Preparation for third-party game callback",id:"preparation-for-third-party-game-callback",level:3},{value:"Game-side Callback Address Interface Description",id:"game-side-callback-address-interface-description",level:3}],p={toc:u};function m(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"in-app-purchase"},"In-app purchase"),(0,i.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"danger")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"}," Need to add USE_IAP macro definition "),"   "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"}," ",(0,i.kt)("a",{parentName:"strong",href:"https://docs.unity3d.com/Packages/com.unity.purchasing@4.13/manual/StoresSupported.html"},"Unity In App Purchasing plugin version 4.13.0 or higher")," (UnityEditor 2021.3.14+) ")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"}," Must achieve ",(0,i.kt)("a",{parentName:"strong",href:"#8reward-issuance-reportmust-join"}," \u30108\u3001reward issuance reporting(Must join)\u3011 ")," ")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"}," SDK will automatically check whether the local contains unverified orders after successful purchase and failed purchase, and it is recommended that developers take the initiative to request a replacement order when entering the main interface. ",(0,i.kt)("a",{parentName:"strong",href:"#9replenishment"},"[9\u3001 replenishment]"),"  ")," "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"}," To test in-app purchases, you need to add your Google account to your Google Background test account first. ")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"}," You need to click the test link on the mobile terminal to join the test account, and you cannot join the test account on the computer terminal. If the PC has been added, log out of the PC.")," ")))),(0,i.kt)("h2",{id:"in-app-purchase-access-method"},"In-app purchase access method"),(0,i.kt)("h3",{id:"1import-iap-plug-in"},"1\u3001Import IAP plug-in"),(0,i.kt)("p",null,"Import the Unity In App Purchasing plug-in.",(0,i.kt)("br",{parentName:"p"}),"\n","Unity menu -> Window -> Package Manager -> In App Purchasing -> Install\u3002"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"}," If you don't see version 4.13.0 In App Purchasing plug-in, follow these steps to add: Add packages by name -> Enter: com.unity.purchasing ")),(0,i.kt)("center",null,(0,i.kt)("img",{src:"../img/HCSDK/image37.png"})),(0,i.kt)("h3",{id:"2add-macro-definition"},"2\u3001Add macro definition"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"USE_IAP \n")),(0,i.kt)("h3",{id:"3add-in-store-items"},"3\u3001Add in-store items"),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"  Two adding methods are supported:",(0,i.kt)("br",{parentName:"p"}),"\n","",(0,i.kt)("strong",{parentName:"p"},"a. Adding an item through the AddProductsStatic interface (",(0,i.kt)("font",{color:"ff0000"},"called before initializing the SDK interface"),")"),"\n",(0,i.kt)("strong",{parentName:"p"},"b. Add the product ID through the AddProducts interface")),"  ",(0,i.kt)("font",{color:"ff0000"}," Note: The added product type must be the same as the background application type, otherwise the corresponding product information may not be requested.")," ",(0,i.kt)("br",null),"ProductType.NonConsumable  It can only be purchased once. Good for one-time purchases, such as extra levels",(0,i.kt)("br",null),"ProductType.Consumable     Can be purchased repeatedly. Suitable for consumable goods such as virtual currency",(0,i.kt)("br",null),"ProductType.Subscription   Can be purchased and restored repeatedly. Durable goods, but for a limited period",(0,i.kt)("br",null)," (subscription)")),(0,i.kt)("p",null,"a. By ",(0,i.kt)("strong",{parentName:"p"}," HachiMgr. Instance. AddProductsStatic add commodity ID ")," interface "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'Dictionary<string, ProductType> ProductDic = new Dictionary<string, ProductType>()\n{\n    { "com.tkkk.unitysdk.demo.1",ProductType.Consumable},\n    { "com.tkkk.unitysdk.demo.a1",ProductType.Consumable},\n    { "com.tkkk.unitysdk.demo.a12",ProductType.Consumable}\n};\n\nHachiMgr.Instance.AddProductsStatic(ProductDic);\n')),(0,i.kt)("font",{color:"ff0000"},"note\uff1aThis method needs to be called before initializing the SDK, that is, set the product information before initializing the SDK."),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("p",null,"b. By ",(0,i.kt)("strong",{parentName:"p"}," HachiMgr. Instance. AddProducts add commodity ID ")," interface"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'Dictionary<string, ProductType> ProductDic = new Dictionary<string, ProductType>()\n{\n    { "com.tkkk.unitysdk.demo.1",ProductType.Consumable},\n    { "com.tkkk.unitysdk.demo.a1",ProductType.Consumable},\n    { "com.tkkk.unitysdk.demo.a12",ProductType.Consumable}\n};\n\nHachiMgr.Instance.AddProducts(ProductDic);\n')),(0,i.kt)("h3",{id:"4initialize-iap-callback"},"4\u3001Initialize iap callback"),(0,i.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"danger")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"The initial callback must be set before SDK initialization"))))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'HachiMgr.Instance.SetOnPurchaseInitLinstener((result,errorMsg)=>\n{\n    if (result)\n    {\n        // Iap init success\n        HMDebugger.LogDebug("Iap init success");\n    }\n    else\n    {\n        // Iap init fail\n        HMDebugger.LogDebug("Iap init fail, errorMsg:"+errorMsg);\n    }\n});\n')),(0,i.kt)("h3",{id:"5buy-listening-callback"},"5\u3001Buy listening callback"),(0,i.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"danger")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Payment callbacks must be set before SDK initialization")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"The payment callback is an asynchronous callback, and when the callback is returned, ensure that the game reward is issued normally. It is suggested that the game side can add a mask to shield user actions during the payment process"),"   ")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"void Start()\n{\n    // Set the purchase listening callback\n    HachiMgr.Instance.RegisterProductsInfoHandler(PurchaseCallback);\n}\n\n/// Apple/Google Pay order number\n/// Custom product name on the game side\n/// The product ID of the payment\n/// Successful payment or not\n/// Game extension field\n/// Whether the recovery purchase is triggered, mainly used to prompt a dialog box(iOS only)\nprivate void PurchaseCallback(string orderID, string productName, string productID, bool purchaseResult, string gameExtra,bool isRestore, PurchasingCode code)\n{\n    if (purchaseResult)\n    {\n        //Successful purchase\n    }\n    else\n    {\n        //Restore purchase\n        if(orderAlreadyExists){\n        \n            //Restore purchase success\n        \n        }else{\n        \n           // Purchase fail\n        \n        }\n    }\n}\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"}," Description: ")," ",(0,i.kt)("br",null)),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Items are normally delivered from purchaseResult or orderAlreadyExists that is true. The game side should handle the reward itself according to the demand, and the reward can not be issued repeatedly for non-consumable items. (If the de-advertising package contains de-advertising +500 diamonds, uninstall and reinstall to resume the purchase, only need to re-reward the de-advertising, and 500 diamonds have been issued before without being issued again,For details about the logic, see the requirements document)",(0,i.kt)("br",null)),(0,i.kt)("li",{parentName:"ol"},"The purchaseResult and orderAlreadyExists fields are not both true. ",(0,i.kt)("br",null)),(0,i.kt)("li",{parentName:"ol"},"The payment status in the callback is described as follows\uff1a")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"public enum PurchasingCode\n{\n    PurchasingUnavailable,          // The system purchase function cannot be used\n    ExistingPurchasePending,        // The previous purchase was in progress when the new purchase was requested\n    ProductUnavailable,             // Unable to buy goods in the store\n    SignatureInvalid,               // Signature verification of purchase receipt failed\n    UserCancelled,                  // The user chose to cancel rather than continue the purchase\n    PaymentDeclined,                // Payment problem\n    DuplicateTransaction,           // A duplicate transaction error that occurs when the transaction has been successfully completed\n    Unknown,                        // Common cause of unidentified purchase problems\n    ServerRequestFailed,            // The client failed to request the server for purchase. Procedure\n    ServerAuthenticationFailed,     // The client purchase succeeds. Server authentication fails\n    PurchasingSuccess               // The client purchase succeeds. The server authentication succeeds\n}\n")),(0,i.kt)("h3",{id:"6purchase-interface"},"6\u3001Purchase interface"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'public void BuyProduct()\n{\n    string productID = "com.tkkk.unitysdk.demo.a1";\n    string productName = "a1";\n    string gameExtra = "a1GameExtraParam";\n    HachiMgr.Instance.PurchaseProductById(productID,productName,gameExtra);\n}\n')),(0,i.kt)("h3",{id:"7restore-purchase-ios-only"},"7\u3001Restore purchase (iOS Only)"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"HachiMgr.Instance.RestorePurchases();\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"}," Description: "),(0,i.kt)("br",null),"\n1.for iOS products, Apple requires that if the in-purchase item contains non-consumable items, there must be a recovery purchase function. ",(0,i.kt)("br",null),"\n2.Restore the purchase function, please add according to the requirement document. The general logic is to add a restore purchase button on the setup screen. After uninstallation and reinstallation, click the Restore purchase button to restore purchased non-consumables. ",(0,i.kt)("br",null),"\n3.when there is a recoverable item, it will eventually be called to the successful purchase callback (point 4), and the game needs to ensure that the reward can be issued normally. ",(0,i.kt)("br",null),"\n4.Example: ",(0,i.kt)("br",null),"\nIf an item is a non-consumable item, the reward is: remove AD and 100 gold. When resuming the purchase, only the remove AD is restored, and 100 gold coins are not restored. ",(0,i.kt)("br",null),"\nEach time the recovery purchase method is called, the successful purchase will be called back, and the game needs to add logic to judge not to repeat or hide the recovery purchase button. ",(0,i.kt)("br",null)),(0,i.kt)("h3",{id:"8reward-issuance-reportmust-join"},"8\u3001Reward issuance report(Must join)"),(0,i.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"danger")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"}," The game must implement this interface to complete the closed loop of internal purchase events.",(0,i.kt)("br",null),"\nThis interface is invoked when one of purchaseResult or orderAlreadyExists is true from Purchaseresult."))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'/// <summary>\n/// IAP games report rewards after delivery\n/// </summary>\n/// <param name="productName">Trade name</param>\n/// <param name="productID">Product SKU ID</param>\n/// <param name="orderID">Order ID</param>\n/// <param name="gameExtra01">Game Expansion field - Number of items purchased</param>\n/// <param name="gameExtra02">Game expansion field</param>\npublic void LogCheckingOrder(string productName, string productID, string orderID, string gameExtra01, string gameExtra02);\n\ne.g:\nprivate void PurchaseCallback(string orderID, string productName, string productID, bool purchaseResult,\n        string gameExtra, bool orderAlreadyExists)\n{\n    if (purchaseResult || orderAlreadyExists)\n    {\n        mPurchaseBtn.text = "Successful purchase";\n        HachiMgr.Instance.LogCheckingOrder(productName,productID,orderID,"gameExtra01","gameExtra02");\n    }\n    else\n    {\n        mPurchaseBtn.text = "Purchase failure";\n    }\n\n    HMDebugger.LogDebug("PurchaseCallback orderID:" + orderID + " productName:" + productName + " productID" +\n                        productID + " purResult" + purchaseResult + " gameExtra:" + gameExtra +\n                        " orderAlreadyExists:" + orderAlreadyExists);\n}\n')),(0,i.kt)("h3",{id:"9replenishment"},"9\u3001replenishment"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"HachiMgr.Instance.ProcessFailedOrders();\n")),(0,i.kt)("p",null,"The SDK will proactively check whether the local contains unverified orders after the purchase success and purchase failure. After the unverified order verification is successful, it will trigger ",(0,i.kt)("a",{parentName:"p",href:"#4buy-listening-callback"},"\u30104\u3001Buy listening callback\u3011"),". The developer can also actively call the replenishment interface for replenishment logic according to the actual situation."),(0,i.kt)("h3",{id:"10gets-the-localized-price-string-interface"},"10\u3001Gets the localized price string interface"),(0,i.kt)("p",null,"Returns a price string with a currency symbol, such as '$1.99' '\uffe56.99'."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"public void GetPriceByID()\n{\n    string productID = \"com.tkkk.unitysdk.demo.a1\";\n   \n    // Returns a price string with a currency symbol, such as '$1.99' '\uffe56.99'.\n    string price = HachiMgr.Instance.GetLocalizedPriceById(productID);\n}\n")),(0,i.kt)("h3",{id:"11query-continuous-subscription-product-information-v314-new"},"11\u3001Query Continuous Subscription product information (v3.1.4 new)"),(0,i.kt)("p",null,"The SDK supports two ways to query information about purchased continuous subscription products:"),(0,i.kt)("h4",{id:"111-registration-callback"},"11.1 Registration callback"),(0,i.kt)("p",null,"Register the callback before initializing the SDK. When the IAP plug-in initializes successfully, the SDK checks whether continuous subscription product information exists.",(0,i.kt)("br",null),"\nThe developer can reclaim the renewal benefits when the order expires, i.e., when validity = false or Is_expired = 1 in HMSubscribeData. (Specific performance can be determined according to the requirements document)"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'public void RegisterSubscriptionValidityHandler(Action<string, bool, HMSubscribeData> onCheckSubscribeValidityAction);\n\ne.g.\uff1a\nHachiMgr.Instance.RegisterSubscriptionValidityHandler((productId,validity,data)=>\n{\n    // productId \n    // validity Indicates whether the validity is expired. fales: the validity is expired. true: the validity is not expired\n    // data Subscription-based product information\n    HMDebugger.LogDebug("SubscribeData ===> "+JsonConvert.SerializeObject(data));\n});\n')),(0,i.kt)("h4",{id:"112-active-query"},"11.2 Active query"),(0,i.kt)("p",null,"Developers can actively call the query interface at the right time to query subscription commodity information"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'public void RegisterSubscriptionValidityHandler(string productId,Action<HMSubscribeData> onCheckSubsribeByProductIdAction);\n\ne.g.\uff1a\nHachiMgr.Instance.RegisterSubscriptionValidityHandler("productId", (data) =>\n{\n    // productId\n    // data Subscription-based product information\n    HMDebugger.LogDebug("SubscribeData ===> "+JsonConvert.SerializeObject(data));\n});\n\n')),(0,i.kt)("p",null,"Continuous Subscription Product Information ",(0,i.kt)("strong",{parentName:"p"}," HMSubscribeData ")," Description is as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"\n    public int Illegal_order;       // 0: indicates a legal order, 1: indicates an illegal order\n    public string Illegal_msg;      // Illegal order information\n    public string Environment;      // production & sandbox\n    public string Purchase_time;    // Subscription time, in milliseconds\n    public int Is_subscribed;       // Subscribed or not 0: Not subscribed. 1: subscribed\n    public int Is_expired;          // Expired 0 Not expired, 1: expired\n    public int Is_cancelled;        // 0: not canceled. 1: canceled\n    public int Is_free_trial;       // 0: not a free trial, 1: a free trial\n    public int Is_auto_renewing;    // Whether to renew automatically 0: not automatic, 1: automatic\n    public string Remaining_time;   // Time remaining for subscription expiration, in milliseconds\n    public string Expiry_time;      // Expiration time, in milliseconds\n    public string Latest_order_id;  // The latest order number for your current subscription\n    public string Product_id;       // Product ID\n        \n")),(0,i.kt)("h3",{id:"12get-all-product-informationoptional"},"12\u3001Get all product information\uff08optional\uff09"),(0,i.kt)("p",null,"Return all configured items on AppStore/Google Play."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"void Start()\n{\n    HachiMgr.Instance.RegisterProductsInfoHandler(OnProductInfoCallback);\n}\n\n public void OnProductInfoCallback(Product[] products)\n {\n    /// ex:\n    ///     products[0].metadata.localizedTitle\n    ///     products[0].metadata.localizedPriceString\n    ///     products[0].metadata.localizedDescription\n    ///     products[0].metadata.isoCurrencyCode\n } \n")),(0,i.kt)("h3",{id:"13get-product-information-based-on-product-idoptional"},"13\u3001Get product information based on product ID\uff08optional\uff09"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'string productID = "com.tkkk.unitysdk.demo.a1";\n\nProduct prodyct = HachiMgr.Instance.GetProductInfoByID(productID);\n')),(0,i.kt)("h3",{id:"14the-in-app-purchase-is-abnormal"},"14\u3001The in-app purchase is abnormal"),(0,i.kt)("p",null,"In case of payment failure, please confirm the following issues:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Payment callbacks must be set before SDK initialization"),(0,i.kt)("li",{parentName:"ul"},"All product categories must be consistent with the background configuration, consumables, non-consumables or subscription products"),(0,i.kt)("li",{parentName:"ul"},"GooglePlay China account cannot be adjusted to pay, you need to switch regions or use another region account"),(0,i.kt)("li",{parentName:"ul"},"Attempts to switch between different vpn nodes due to network reasons")),(0,i.kt)("h3",{id:"15products-with-ads-removed-must-be-accepted"},"15\u3001Products with ads removed must be accepted"),(0,i.kt)("p",null,"After the successful purchase of unadvertised goods, the following interface needs to be called to remove screen insertion ads, open screen ads, and banner ads."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},"Toolbelt.SetRemoveAds();\n")),(0,i.kt)("h2",{id:"server-integration-optional"},"Server Integration (Optional)"),(0,i.kt)("p",null,"After a successful payment through the SDK, the game retrieves the payment result via a callback. For games with a server, it is recommended to prioritize integration with the SDK server's payment callback interface. After a successful payment, the SDK server will notify the game server to deliver the purchased goods. In the case of standalone games, ensure that the goods are delivered to the player after receiving a successful payment callback from the client."),(0,i.kt)("h3",{id:"preparation-for-third-party-game-callback"},"Preparation for third-party game callback"),(0,i.kt)("p",null,"1\u3001Obtain game-side authorization encryption secret from the integration partner.",(0,i.kt)("br",{parentName:"p"}),"\n","2\u3001Provide the game-side callback URL to the integration partner for configuration."),(0,i.kt)("p",null,"Currently, only one payment callback address can be configured in the background. If the payment callback is required to multiple servers, the R&D server must perform interface forwarding. For example, synchronous forwarding to an online server and a test server."),(0,i.kt)("h3",{id:"game-side-callback-address-interface-description"},"Game-side Callback Address Interface Description"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"}," 1\u3001Request Method: Post        "),(0,i.kt)("br",{parentName:"p"}),"\n",(0,i.kt)("strong",{parentName:"p"},"2\u3001Header Authorization:  ",(0,i.kt)("inlineCode",{parentName:"strong"},"Authorization: secretkey "),"                        "),(0,i.kt)("br",{parentName:"p"}),"\n",(0,i.kt)("strong",{parentName:"p"},"3\u3001Body Json        "),"      "),(0,i.kt)("table",null,(0,i.kt)("tr",null,(0,i.kt)("td",null,"Name"),(0,i.kt)("td",null,"Type"),(0,i.kt)("td",null,"isRequired"),(0,i.kt)("td",null,"Des"),(0,i.kt)("td",null,"Example Value")),(0,i.kt)("tr",null,(0,i.kt)("td",null,"env"),(0,i.kt)("td",null,"String"),(0,i.kt)("td",null,"Y"),(0,i.kt)("td",null,"Environment ",(0,i.kt)("br",null),"(qa: test; prod: production)"),(0,i.kt)("td",null,"prod")),(0,i.kt)("tr",null,(0,i.kt)("td",null,"platform"),(0,i.kt)("td",null,"String"),(0,i.kt)("td",null,"Y"),(0,i.kt)("td",null,"platform\uff08android/ios\uff09"),(0,i.kt)("td",null,"android")),(0,i.kt)("tr",null,(0,i.kt)("td",null,"pkg"),(0,i.kt)("td",null,"String"),(0,i.kt)("td",null,"Y"),(0,i.kt)("td",null,"package name"),(0,i.kt)("td",null,"com.test.demo")),(0,i.kt)("tr",null,(0,i.kt)("td",null,"user_id"),(0,i.kt)("td",null,"String"),(0,i.kt)("td",null,"Y"),(0,i.kt)("td",null,"UserID"),(0,i.kt)("td",null,"0cc852594cb2dfd0381af38f687b44906")),(0,i.kt)("tr",null,(0,i.kt)("td",null,"product_id"),(0,i.kt)("td",null,"String"),(0,i.kt)("td",null,"Y"),(0,i.kt)("td",null,"Product ID"),(0,i.kt)("td",null,"com.tkkk.unitysdk.demo.a1")),(0,i.kt)("tr",null,(0,i.kt)("td",null,"order_id"),(0,i.kt)("td",null,"String"),(0,i.kt)("td",null,"Y"),(0,i.kt)("td",null,"Order ID"),(0,i.kt)("td",null,"GPA.3340-7674-3284-90321")),(0,i.kt)("tr",null,(0,i.kt)("td",null,"price"),(0,i.kt)("td",null,"String"),(0,i.kt)("td",null,"Y"),(0,i.kt)("td",null,"Price"),(0,i.kt)("td",null,"1.99")),(0,i.kt)("tr",null,(0,i.kt)("td",null,"currency"),(0,i.kt)("td",null,"String"),(0,i.kt)("td",null,"Y"),(0,i.kt)("td",null,"Currency"),(0,i.kt)("td",null,"USD")),(0,i.kt)("tr",null,(0,i.kt)("td",null,"game_extra_param"),(0,i.kt)("td",null,"String"),(0,i.kt)("td",null,"N"),(0,i.kt)("td",null,"Game Extra Param"),(0,i.kt)("td",null,"game_extra_param_value")),(0,i.kt)("tr",null,(0,i.kt)("td",null,"ts"),(0,i.kt)("td",null,"String"),(0,i.kt)("td",null,"Y"),(0,i.kt)("td",null,"Timestamp"),(0,i.kt)("td",null,"1692346624")),(0,i.kt)("tr",null,(0,i.kt)("td",null,"sign"),(0,i.kt)("td",null,"String"),(0,i.kt)("td",null,"Y"),(0,i.kt)("td",null,"Encrypted Value"),(0,i.kt)("td",null,"33dasfdewffggg"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'Body JSON Example \uff08secretkey: 64f1b1fb8efadc41dcd29d5c\uff09\n{\n    "env": "qa",\n    "platform": "android",\n    "pkg": "com.test.demo",\n    "user_id": "0cc852594cb2dfd0381af38f687b44906",\n    "product_id": "com.tkkk.unitysdk.demo.a1",\n    "order_id": "GPA.3340-7674-3284-90321",\n    "price": "1.99",\n    "currency": "USD",\n    "game_extra_param":"game_extra_param_value"\n    "ts": "1692346624",\n    "sign": "c9e91f2b7d28eec1130df9ddea5697e8"\n}\n\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"}," 4\u3001Encryption Method "),(0,i.kt)("br",{parentName:"p"}),"\n",'Calculate the value of the "Sign" field by concatenating the parameter values (parameter value 1 + parameter value 2 + parameter value n + secret key) in the order of the returned parameters, and then applying MD5 encryption. The "+" sign is used as a connector and is not included in the calculation.'),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-c"},'$sign = md5("qa"+"android"+"com.test.demo"+"0cc852594cb2dfd0381af38f687b44906"+"com.tkkk.unitysdk.demo.a1"+"GPA.3340-7674-3284-90321"+"1.99"+"USD"+"game_extra_param_value"+"1692346624"+$secretKey)\n')),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"}," 5\u3001Retry Mechanism "),(0,i.kt)("br",{parentName:"p"}),"\n","Retry up to 10 times within a 5-hour timeframe with the following intervals:"),(0,i.kt)("p",null,"Retry 1: After 35 seconds   ",(0,i.kt)("br",null),"\nRetry 2: After 40 seconds   ",(0,i.kt)("br",null),"\nRetry 3: After 115 seconds   ",(0,i.kt)("br",null),"\nRetry 4: After 150 seconds   ",(0,i.kt)("br",null),"\nRetry 5: After 385 seconds   ",(0,i.kt)("br",null),"\nRetry 6: After 755 seconds   ",(0,i.kt)("br",null),"\nRetry 7: After 1500 seconds   ",(0,i.kt)("br",null),"\nRetry 8: After 2610 seconds   ",(0,i.kt)("br",null),"\nRetry 9: After 4230 seconds   ",(0,i.kt)("br",null),"\nRetry 10: After 6850 seconds   ",(0,i.kt)("br",null),"\nContinue retrying until the returned HTTP status is 200 and the output is 'success'."))}m.isMDXComponent=!0}}]);